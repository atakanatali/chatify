apiVersion: batch/v1
kind: Job
metadata:
  name: chatify-scylla-schema-init
  namespace: chatify
  labels:
    app.kubernetes.io/name: chatify-scylla-schema-init
    app.kubernetes.io/component: initialization
    app.kubernetes.io/part-of: chatify
    app.kubernetes.io/managed-by: kubectl
spec:
  ttlSecondsAfterFinished: 300
  backoffLimit: 3
  template:
    metadata:
      labels:
        app.kubernetes.io/name: chatify-scylla-schema-init
        app.kubernetes.io/component: initialization
        app.kubernetes.io/part-of: chatify
    spec:
      restartPolicy: OnFailure
      containers:
        - name: cqlsh
          image: scylladb/scylla:5.4.0
          command:
            - /bin/bash
            - -c
            - |
              #!/bin/bash
              set -e

              # Wait for ScyllaDB to be ready
              echo "Waiting for ScyllaDB to be ready..."
              until cqlsh chatify-scylla 9042 --execute "DESCRIBE KEYSPACES"; do
                echo "ScyllaDB is unavailable - sleeping"
                sleep 5
              done
              echo "ScyllaDB is up - executing schema initialization"

              # Create keyspace with replication strategy
              # Using NetworkTopologyStrategy for production readiness
              # Single replica for kind/local development
              cqlsh chatify-scylla 9042 --execute "
                CREATE KEYSPACE IF NOT EXISTS chatify
                WITH replication = {
                  'class': 'SimpleStrategy',
                  'replication_factor': '1'
                }
                AND durable_writes = true;
              "

              echo "Keyspace 'chatify' created successfully"

              # Create chat_messages table
              # Primary key design:
              # - Partition key: scope_id (groups messages by scope for efficient queries)
              # - Clustering key: (created_at_utc, message_id) for time-based ordering
              cqlsh chatify-scylla 9042 --execute "
                CREATE TABLE IF NOT EXISTS chatify.chat_messages (
                  scope_id text,
                  created_at_utc timestamp,
                  message_id uuid,
                  sender_id text,
                  text text,
                  origin_pod_id text,
                  broker_partition int,
                  broker_offset bigint,
                  PRIMARY KEY ((scope_id), created_at_utc, message_id)
                ) WITH CLUSTERING ORDER BY (created_at_utc ASC)
                AND gc_grace_seconds = 864000
                AND default_time_to_live = 0
                AND comment = 'Chat messages table for Chatify - stores all chat messages with metadata'
                AND compaction = {
                  'class': 'SizeTieredCompactionStrategy',
                  'enabled': true,
                  'tombstone_threshold': 0.2,
                  'tombstone_compaction_interval': 86400
                }
                AND compression = {
                  'sstable_compression': 'LZ4Compressor',
                  'chunk_length_in_kb': 64
                };
              "

              echo "Table 'chat_messages' created successfully"

              # Verify schema creation
              cqlsh chatify-scylla 9042 --execute "
                DESCRIBE KEYSPACE chatify;
              "

              echo "Schema initialization completed successfully"
              echo ""
              echo "Schema summary:"
              echo "  Keyspace: chatify"
              echo "  Tables:"
              echo "    - chat_messages: stores chat messages with time-based clustering"
              echo ""
              echo "Table structure:"
              cqlsh chatify-scylla 9042 --execute "
                SELECT * FROM system_schema.columns
                WHERE keyspace_name = 'chatify'
                AND table_name = 'chat_messages'
                ORDER BY column_name;
              "
          env:
            - name: POD_IP
              valueFrom:
                fieldRef:
                  fieldPath: status.podIP
