---
# ConfigMap for Flink JobManager configuration
# Provides environment variables and configuration for the Apache Flink JobManager deployment.
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: chatify-flink-jobmanager-config
  namespace: chatify
  labels:
    app.kubernetes.io/name: chatify-flink-jobmanager
    app.kubernetes.io/component: stream-processor
    app.kubernetes.io/part-of: chatify
    app.kubernetes.io/managed-by: kubectl
data:
  # Kafka bootstrap servers for Flink to consume from chat-events topic
  FLINK_PROPERTIES: |
    jobmanager.rpc.address: chatify-flink-jobmanager
    jobmanager.rpc.port: 6123
    jobmanager.memory.process.size: 1024m
    jobmanager.execution.failover-strategy: region
    # Increased frame size to prevent TooLongFrameException
    akka.framesize: 50m
    rest.server.max-content-length: 104857600
    taskmanager.memory.process.size: 1024m
    taskmanager.numberOfTaskSlots: 3
    parallelism.default: 2
    state.backend: rocksdb
    state.savepoints.dir: file:///flink/data/savepoints
    state.checkpoints.dir: file:///flink/data/checkpoints
    rest.address: 0.0.0.0
    rest.port: 8081
    # Kafka consumer configuration for consuming from chat-events
    kafka.bootstrap.servers: chatify-kafka:9092
    kafka.group.id: chatify-flink-consumer
    kafka.auto.offset.reset: earliest
    # High availability settings for JobManager recovery
    high-availability: none
    # Metrics reporting to Prometheus (optional, for observability)
    metrics.reporter.prom.class: org.apache.flink.metrics.prometheus.PrometheusReporter
    metrics.reporter.prom.port: 9999
---
# Service for Flink JobManager RPC communication
# Provides internal cluster IP service for TaskManagers to connect to JobManager.
---
apiVersion: v1
kind: Service
metadata:
  name: chatify-flink-jobmanager
  namespace: chatify
  labels:
    app.kubernetes.io/name: chatify-flink-jobmanager
    app.kubernetes.io/component: stream-processor
    app.kubernetes.io/part-of: chatify
    app.kubernetes.io/managed-by: kubectl
spec:
  type: ClusterIP
  clusterIP: None
  ports:
    - name: rpc
      port: 6123
      targetPort: 6123
      protocol: TCP
    - name: blob
      port: 6124
      targetPort: 6124
      protocol: TCP
    - name: query
      port: 6125
      targetPort: 6125
      protocol: TCP
    - name: ui
      port: 8081
      targetPort: 8081
      protocol: TCP
  selector:
    app.kubernetes.io/name: chatify-flink-jobmanager
    app.kubernetes.io/component: stream-processor
    app.kubernetes.io/part-of: chatify
---
# Service for Flink Web UI external access
# Provides NodePort service for accessing Flink Web UI from host machine.
---
apiVersion: v1
kind: Service
metadata:
  name: chatify-flink-jobmanager-ui
  namespace: chatify
  labels:
    app.kubernetes.io/name: chatify-flink-jobmanager
    app.kubernetes.io/component: stream-processor
    app.kubernetes.io/part-of: chatify
    app.kubernetes.io/managed-by: kubectl
spec:
  type: NodePort
  ports:
    - name: ui
      port: 8081
      targetPort: 8081
      nodePort: 30081
      protocol: TCP
  selector:
    app.kubernetes.io/name: chatify-flink-jobmanager
    app.kubernetes.io/component: stream-processor
    app.kubernetes.io/part-of: chatify
---
# Deployment for Flink JobManager
# Manages the Apache Flink JobManager which is the coordinator of the Flink cluster.
# The JobManager receives jobs, schedules tasks, and coordinates checkpoints.
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: chatify-flink-jobmanager
  namespace: chatify
  labels:
    app.kubernetes.io/name: chatify-flink-jobmanager
    app.kubernetes.io/component: stream-processor
    app.kubernetes.io/part-of: chatify
    app.kubernetes.io/managed-by: kubectl
spec:
  replicas: 1
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 0
      maxUnavailable: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: chatify-flink-jobmanager
      app.kubernetes.io/component: stream-processor
      app.kubernetes.io/part-of: chatify
  template:
    metadata:
      labels:
        app.kubernetes.io/name: chatify-flink-jobmanager
        app.kubernetes.io/component: stream-processor
        app.kubernetes.io/part-of: chatify
        app.kubernetes.io/managed-by: kubectl
    spec:
      containers:
        - name: jobmanager
          image: flink:1.20.0-scala_2.12-java11
          ports:
            - name: rpc
              containerPort: 6123
              protocol: TCP
            - name: blob
              containerPort: 6124
              protocol: TCP
            - name: query
              containerPort: 6125
              protocol: TCP
            - name: ui
              containerPort: 8081
              protocol: TCP
            - name: prometheus
              containerPort: 9999
              protocol: TCP
          env:
            - name: FLINK_PROPERTIES
              valueFrom:
                configMapKeyRef:
                  name: chatify-flink-jobmanager-config
                  key: FLINK_PROPERTIES
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: JOB_MANAGER_RPC_ADDRESS
              value: "chatify-flink-jobmanager"
          args:
            - jobmanager
          resources:
            limits:
              cpu: "1000m"
              memory: "1Gi"
            requests:
              cpu: "250m"
              memory: "768Mi"
          livenessProbe:
            httpGet:
              path: /
              port: 8081
              scheme: HTTP
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
          readinessProbe:
            httpGet:
              path: /
              port: 8081
              scheme: HTTP
            initialDelaySeconds: 15
            periodSeconds: 5
            timeoutSeconds: 3
            failureThreshold: 3
          volumeMounts:
            - name: flink-data
              mountPath: /flink/data
      volumes:
        - name: flink-data
          emptyDir: {}
      restartPolicy: Always
