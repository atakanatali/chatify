apiVersion: batch/v1
kind: Job
metadata:
  name: chatify-kibana-init
  namespace: chatify
  labels:
    app.kubernetes.io/name: chatify-kibana-init
    app.kubernetes.io/component: logging
    app.kubernetes.io/part-of: chatify
spec:
  template:
    spec:
      containers:
      - name: init-kibana
        image: curlimages/curl:latest
        command: ["/bin/sh", "-c"]
        args:
          - |
            echo "‚è≥ Waiting for Kibana to be ready..."
            until curl -s http://chatify-kibana:5601/api/status | grep -q '"state":"green"'; do
              echo "   Still waiting for Kibana..."
              sleep 5
            done
            echo "‚úÖ Kibana is ready!"

            echo "üì¶ Creating Data View 'logs-*'..."
            curl -X POST "http://chatify-kibana:5601/api/data_views/data_view" \
              -H 'kbn-xsrf: true' \
              -H 'Content-Type: application/json' \
              -d '{"data_view": {"title": "logs-*", "name": "Logs", "id": "logs"}}'
            
            echo "‚úÖ Data View Created!"
      restartPolicy: OnFailure
